<html>
<head>
    <link rel="stylesheet" type="text/css" href="./css/style.css" />

    <script src="./js/jquery.js" type="text/javascript"></script>
    <script src="./js/rgraph/RGraph.common.core.js" type="text/javascript"></script>
    <script src="./js/rgraph/RGraph.common.tooltips.js" type="text/javascript"></script>
    <script src="./js/rgraph/RGraph.common.dynamic.js" type="text/javascript"></script>
    <script src="./js/rgraph/RGraph.common.effects.js" type="text/javascript"></script>
    <script src="./js/rgraph/RGraph.common.resizing.js" type="text/javascript"></script>
    <script src="./js/rgraph/RGraph.common.key.js" ></script>
    <script src="./js/rgraph/RGraph.bar.js" type="text/javascript"></script>
    <script src="./js/rgraph/RGraph.line.js" type="text/javascript"></script>
    <script src="./js/rgraph/RGraph.pie.js" type="text/javascript"></script>

    <script type="text/javascript">
        // Colors from http://www.wowwiki.com/Class_colors
        var CLASS_COLORS = {
            'DEATHKNIGHT':  '#C41F3B',
            'DRUID':        '#FF7D0A',
            'HUNTER':       '#ABD473',
            'MAGE':         '#69CCF0',
            'MONK':         '#558A84',
            'PALADIN':      '#F58CBA',
            'PRIEST':       '#FFFFFF',
            'ROGUE':        '#FFF569',
            'SHAMAN':       '#0070DE',
            'WARLOCK':      '#9482C9',
            'WARRIOR':      '#C79C6E',
        };

        var DEFAULT_COLOR = '#808080';

        var entries = $ENTRIES$;
        var timestamps = $TIMETAMPS$;
        var character_names = $CHARACTER_NAMES$;
        var characters_to_ignore = $CHARACTERS_TO_IGNORE$;
        var characters_colors = $CHARACTERS_COLORS$;


        function getColor(name)
        {
            if (characters_colors[name] !== undefined)
                return characters_colors[name];
            else if (CLASS_COLORS[entries[name].class] !== undefined)
                return CLASS_COLORS[entries[name].class];

            return DEFAULT_COLOR;
        }


        function getScaleFactor(value)
        {
            var exponent = Math.floor(Math.log(value) / Math.log(10));
            return Math.pow(10, exponent);
        }


        function createRowLegend(character_name)
        {
            var row = document.createElement('tr');

            var color_cell = document.createElement('td');
            color_cell.style.width = '25px';
            color_cell.style.backgroundColor = getColor(character_name);
            row.appendChild(color_cell);

            var name_cell = document.createElement('td');
            name_cell.textContent = character_name;
            row.appendChild(name_cell);

            return row;
        }

        function drawPerCharacterPlayTimeAndMoney()
        {
            // Prepare the data for the bar chart
            var data = new Array();
            var data_money = new Array();
            var last_money = new Array();
            var colors = new Array();
            var labels = new Array();
            var tooltips_stacked = new Array();
            var tooltips_stacked_money = new Array();

            var offset = Math.max(timestamps.length - 15, 0);
            var date_start = new Date(timestamps[offset + 1] * 1000);
            var date_end = new Date(timestamps[timestamps.length-1] * 1000);

            $('#graph_character_played_title').text(date_start.toLocaleDateString() + ' - ' + date_end.toLocaleDateString());

            var current_character = 0;
            for (var i = 0; i < character_names.length; ++i)
            {
                if (characters_to_ignore.indexOf(character_names[i]) !== -1)
                    continue;

                colors[current_character] = getColor(character_names[i]);
                last_money[i] = 0;

                var previous_timestamp = null;
                for (var j = offset; j < timestamps.length; ++j)
                {
                    var str_timestamp = Number(timestamps[j]).toString();

                    if ((j > offset) && (i == 0))
                    {
                        data[j-1] = new Array();
                        tooltips_stacked[j-1] = new Array();
                        data_money[j-1] = new Array();
                        tooltips_stacked_money[j-1] = new Array();
                    }

                    if (entries[character_names[i]].sessions[str_timestamp] !== undefined)
                    {
                        if (previous_timestamp !== null)
                        {
                            var duration = entries[character_names[i]].sessions[str_timestamp].played - entries[character_names[i]].sessions[previous_timestamp].played;

                            data[j-1][current_character] = duration / 3600.0;

                            var seconds = duration % 60;
                            var minutes = ((duration - seconds) / 60) % 60;
                            var hours = (duration - minutes * 60 - seconds) / 3600;

                            var text = character_names[i] + ' (';

                            if (hours < 10)
                                text += '0';
                            text += hours + ':';

                            if (minutes < 10)
                                text += '0';
                            text += minutes + ':';

                            if (seconds < 10)
                                text += '0';
                            text += seconds + ')';

                            tooltips_stacked[j-1][current_character] = text;

                            previous_timestamp = str_timestamp
                        }
                        else
                        {
                            previous_timestamp = str_timestamp;
                            if (j > offset)
                            {
                                data[j-1][current_character] = 0;
                                tooltips_stacked[j-1][current_character] = '';
                            }
                        }

                        if (j > offset)
                        {
                            if (entries[character_names[i]].sessions[str_timestamp].money !== undefined)
                                last_money[i] = entries[character_names[i]].sessions[str_timestamp].money / 10000;

                            data_money[j-1][current_character] = last_money[i];
                        }
                    }
                    else if (j > offset)
                    {
                        data[j-1][current_character] = 0;
                        tooltips_stacked[j-1][current_character] = '';
                        data_money[j-1][current_character] = last_money[i];
                    }

                    if (j > offset)
                    {
                        var money_po = Math.floor(last_money[i]);
                        var money_pa = Math.floor((last_money[i] * 100) % 100);
                        var money_pc = Math.floor((last_money[i] * 10000) % 100);

                        var text_money = character_names[i] + ' (';
                        text_money += money_po + ' po '
                        text_money += money_pa + ' pa '
                        text_money += money_pc + ' pc'
                        text_money += ')';
                        tooltips_stacked_money[j-1][current_character] = text_money;
                    }
                }

                ++current_character;
            }

            var tooltips = new Array();
            for (var j = 0; j < tooltips_stacked.length; ++j)
            {
                for (var i = 0; i < tooltips_stacked[j].length; ++i)
                    tooltips[j * tooltips_stacked[j].length + i] = tooltips_stacked[j][i];
            }

            var tooltips_money = new Array();
            for (var j = 0; j < tooltips_stacked_money.length; ++j)
            {
                for (var i = 0; i < tooltips_stacked_money[j].length; ++i)
                    tooltips_money[j * tooltips_stacked_money[j].length + i] = tooltips_stacked_money[j][i];
            }


            var current_year = null;
            var current_month = null;
            var max_value = 1;
            var max_value_money = 1;

            for (var j = 1; j < timestamps.length; ++j)
            {
                var date = new Date(timestamps[j] * 1000);

                labels[j-1] = date.getUTCDate();

                if (current_month != date.getUTCMonth())
                {
                    labels[j-1] = labels[j-1] + '/' + (date.getUTCMonth() + 1);
                    current_month = date.getUTCMonth();
                }

                if (current_year != date.getUTCFullYear())
                {
                    labels[j-1] = labels[j-1] + '/' + date.getUTCFullYear();
                    current_year = date.getUTCFullYear();
                }

                var total = 0;
                for (var i = 0; i < data[j-1].length; ++i)
                    total += data[j-1][i];
                max_value = Math.max(max_value, total);

                var total_money = 0;
                for (var i = 0; i < data_money[j-1].length; ++i)
                    total_money += data_money[j-1][i];
                max_value_money = Math.max(max_value_money, total_money);
            }

            max_value = Math.ceil(max_value);

            var factor = getScaleFactor(max_value_money);
            max_value_money = Math.ceil(max_value_money / factor) * factor;


            // Create the bar chart
            var gutterLeft = 50;

            var bar = new RGraph.Bar('graph_character_played', data);
            bar.Set('chart.labels', labels);
            bar.Set('chart.labels.colors', ['black']);
            bar.Set('chart.tooltips', tooltips);
            bar.Set('chart.gutter.left', gutterLeft);
            bar.Set('chart.background.barcolor1', 'white');
            bar.Set('chart.background.barcolor2', 'white');
            bar.Set('chart.background.grid', true);
            bar.Set('chart.colors', colors);
            bar.Set('chart.grouping', 'stacked');
            bar.Set('chart.hmargin', 10);
            bar.Set('chart.strokestyle', '#000000');
            bar.Set('chart.ymax', max_value);
            bar.Set('chart.variant', '3d');
            bar.Set('chart.background.grid.autofit.numhlines', max_value);
            bar.Set('chart.noaxes', true);
            bar.Set('chart.ylabels', false);

            // Draws the extra axe. It's run whenever the bar object is drawn
            RGraph.AddCustomEventListener(bar, 'ondraw', function ()
                {
                    RGraph.DrawAxes(bar, {
                                          'axis.x': gutterLeft,
                                          'axis.color': 'black',
                                          'axis.text.color': 'black',
                                          'axis.max': max_value,
                                          'axis.numlabels': max_value,
                                          'axis.numticks': max_value * 2,
                                          'axis.min': 0,
                                          'axis.align': 'left',
                                          'axis.units.post': 'h',
                                          'axis.scale.decimals': 0,
                                         });
                }
            );

            bar.Draw();

            var bar_money = new RGraph.Bar('graph_character_money', data_money);
            bar_money.Set('chart.labels', labels);
            bar_money.Set('chart.labels.colors', ['black']);
            bar_money.Set('chart.tooltips', tooltips_money);
            bar_money.Set('chart.gutter.left', 80);
            bar_money.Set('chart.background.barcolor1', 'white');
            bar_money.Set('chart.background.barcolor2', 'white');
            bar_money.Set('chart.background.grid', true);
            bar_money.Set('chart.colors', colors);
            bar_money.Set('chart.grouping', 'stacked');
            bar_money.Set('chart.hmargin', 10);
            bar_money.Set('chart.strokestyle', '#000000');
            bar_money.Set('chart.ymax', max_value_money);
            bar_money.Set('chart.variant', '3d');
            bar_money.Set('chart.units.post', ' po');
            bar_money.Draw();


            // Fill the legend panel
            var legend = $('#legend');
            var legend_money = $('#legend_money');
            for (var i = 0; i < character_names.length; ++i)
            {
                if (characters_to_ignore.indexOf(character_names[i]) !== -1)
                    continue;

                legend.append(createRowLegend(character_names[i]));
                legend_money.append(createRowLegend(character_names[i]));
            }
        }


        function drawTotalPlayTime()
        {
            // Prepare the data for the line charts
            var data_time = new Array();
            var data_money = new Array();
            var labels = new Array();
            var last_money = new Array();

            for (var i = 0; i < character_names.length; ++i)
            {
                if (characters_to_ignore.indexOf(character_names[i]) !== -1)
                    continue;

                last_money[i] = 0;

                var previous_timestamp = null;
                for (var j = 0; j < timestamps.length; ++j)
                {
                    var str_timestamp = Number(timestamps[j]).toString();

                    if ((j > 0) && (i == 0))
                    {
                        data_time[j-1] = 0;
                        data_money[j-1] = 0;
                    }

                    if (entries[character_names[i]].sessions[str_timestamp] !== undefined)
                    {
                        if (previous_timestamp !== null)
                        {
                            var duration = entries[character_names[i]].sessions[str_timestamp].played - entries[character_names[i]].sessions[previous_timestamp].played;
                            data_time[j-1] += duration / 3600.0;

                            if (entries[character_names[i]].sessions[str_timestamp].money !== undefined)
                                last_money[i] = entries[character_names[i]].sessions[str_timestamp].money;

                            data_money[j-1] += last_money[i];

                            previous_timestamp = str_timestamp;
                        }
                        else
                        {
                            previous_timestamp = str_timestamp;
                        }
                    }
                    else if (previous_timestamp !== null)
                    {
                        data_money[j-1] += last_money[i];
                    }
                }
            }

            var current_year = null;
            var current_month = null;
            var max_value_time = 1;
            var max_value_money = 1;
            var min_value_money = 0;
            var money_started = false;

            for (var j = 1; j < timestamps.length; ++j)
            {
                var date = new Date(timestamps[j] * 1000);

                labels[j-1] = '';

                if (timestamps.length < 31)
                    labels[j-1] = date.getUTCDate();

                if (current_month != date.getUTCMonth())
                {
                    if (timestamps.length < 31)
                        labels[j-1] += '/';

                    labels[j-1] += date.getUTCMonth() + 1;
                    current_month = date.getUTCMonth();
                }

                if (current_year != date.getUTCFullYear())
                {
                    labels[j-1] += '/' + date.getUTCFullYear();
                    current_year = date.getUTCFullYear();
                }

                if (!money_started && (data_money[j-1] == 0))
                {
                    data_money[j-1] = null;
                }
                else
                {
                    data_money[j-1] = data_money[j-1] / (100 * 100);
                    max_value_money = Math.max(max_value_money, data_money[j-1]);

                    if (money_started)
                    {
                        min_value_money = Math.min(min_value_money, data_money[j-1]);
                    }
                    else
                    {
                        min_value_money = data_money[j-1];
                        money_started = true;
                    }
                }

                max_value_time = Math.max(max_value_time, data_time[j-1]);
            }

            max_value_time = Math.ceil(max_value_time);

            if (max_value_money == min_value_money) {
                max_value_money = max_value_money + 1000;
                min_value_money = min_value_money - 1000;
                if (min_value_money < 0) {
                    min_value_money = 0;
                }
            }

            var factor = getScaleFactor(max_value_money - min_value_money);

            max_value_money = Math.ceil(max_value_money / factor) * factor;
            min_value_money = Math.floor(min_value_money / factor) * factor;


            // Create the line charts
            var gutterLeft = 50;
            var gutterRight = 100;
            var gutterTop   = 25;

            var line1 = new RGraph.Line('graph_day_played', data_time);
            line1.Set('chart.labels', labels);
            line1.Set('chart.gutter.right', gutterRight);
            line1.Set('chart.gutter.left', gutterLeft);
            line1.Set('chart.gutter.top', gutterTop);
            line1.Set('chart.background.barcolor1', 'white');
            line1.Set('chart.background.barcolor2', 'white');
            line1.Set('chart.background.grid.autofit.numhlines', max_value_time);
            line1.Set('chart.background.grid', true);
            line1.Set('chart.colors', ['red', 'blue']);
            line1.Set('chart.key', ['Time played', 'Money']);
            line1.Set('chart.key.position', 'gutter');
            line1.Set('chart.key.position.gutter.boxed', false);
            line1.Set('chart.key.position.x', 475);
            line1.Set('chart.linewidth', 2);
            line1.Set('chart.filled', false);
            line1.Set('chart.hmargin', 10);
            line1.Set('chart.units.post', 'h');
            line1.Set('chart.ymax', max_value_time);
            line1.Set('chart.noaxes', true);
            line1.Set('chart.ylabels', false);
            line1.Draw();

            var line2 = new RGraph.Line('graph_day_played', data_money);
            line2.Set('chart.gutter.left', 45);
            line2.Set('chart.gutter.right', gutterRight);
            line2.Set('chart.gutter.left', gutterLeft);
            line2.Set('chart.gutter.top', gutterTop);
            line2.Set('chart.background.grid', false);
            line2.Set('chart.colors', ['blue']);
            line2.Set('chart.linewidth', 2);
            line2.Set('chart.filled', false);
            line2.Set('chart.hmargin', 10);
            line2.Set('chart.units.post', 'po');
            line2.Set('chart.ymax', max_value_money);
            line2.Set('chart.ymin', min_value_money);
            line2.Set('chart.noaxes', true);
            line2.Set('chart.ylabels', false);

            // Draws the extra axes. It's run whenever the line2 object is drawn
            RGraph.AddCustomEventListener(line2, 'ondraw', function ()
                {
                    RGraph.DrawAxes(line1, {
                                            'axis.x': gutterLeft,
                                            'axis.color': 'red',
                                            'axis.text.color': 'red',
                                            'axis.max': max_value_time,
                                            'axis.numlabels': max_value_time,
                                            'axis.numticks': max_value_time * 2,
                                            'axis.min': 0,
                                            'axis.align': 'left',
                                            'axis.units.post': 'h',
                                            'axis.scale.decimals': 0,
                                           });
                    RGraph.DrawAxes(line2, {
                                            'axis.x': line1.canvas.width - gutterRight,
                                            'axis.color': 'blue',
                                            'axis.text.color': 'blue',
                                            'axis.max': max_value_money,
                                            'axis.min': min_value_money,
                                            'axis.numlabels': max_value_time,
                                            'axis.numticks': max_value_time * 2,
                                            'axis.align': 'right',
                                            'axis.units.post': ' po',
                                           });
                }
            );

            line2.Draw();
        }


        function drawCharactersPie(canvas_id, limit)
        {
            // Prepare the data for the pie chart
            var data = new Array();
            var labels = new Array();
            var colors = new Array();

            var current_character = 0;
            var total = 0;
            for (var i = 0; i < character_names.length; ++i)
            {
                if (characters_to_ignore.indexOf(character_names[i]) !== -1)
                    continue;

                var reference = 0;
                if ((limit !== null) && (limit < timestamps.length))
                {
                    var start_index = timestamps.length - limit - 1;

                    while (start_index >= 0)
                    {
                        var str_timestamp = Number(timestamps[start_index]).toString();

                        if (entries[character_names[i]].sessions[str_timestamp] !== undefined)
                        {
                            reference = entries[character_names[i]].sessions[str_timestamp].played;
                            break;
                        }

                        --start_index;
                    }

                    if (start_index < 0)
                    {
                        start_index = timestamps.length - limit;

                        while (start_index < timestamps.length)
                        {
                            var str_timestamp = Number(timestamps[start_index]).toString();

                            if (entries[character_names[i]].sessions[str_timestamp] !== undefined)
                            {
                                reference = entries[character_names[i]].sessions[str_timestamp].played;
                                break;
                            }

                            ++start_index;
                        }
                    }
                }

                var str_last_timestamp = Number(entries[character_names[i]].last).toString();
                var duration = entries[character_names[i]].sessions[str_last_timestamp].played - reference;

                if (duration > 0)
                {
                    data[current_character] = duration;
                    labels[current_character] = character_names[i];
                    colors[current_character] = getColor(character_names[i]);

                    total += duration;

                    ++current_character;
                }
            }

            for (var i = 0; i < data.length; ++i)
            {
                var percentage = 100.0 * data[i] / total;
                percentage = percentage - ((percentage * 100) % 100) / 100;
                labels[i] += ' (' + percentage + '%)'
            }

            // Create the pie chart
            var pie = new RGraph.Pie(canvas_id, data);
            pie.Set('chart.tooltips', labels);
            pie.Set('chart.linewidth', 2);
            pie.Set('chart.colors', colors);
            pie.Set('chart.strokestyle', '#000000');
            pie.Draw();
        }

    </script>
</head>
<body>

    <a href="https://github.com/Kanma/TitanPlayed">
        <img style="position: absolute; top: 0; right: 0; border: 0;" src="https://s3.amazonaws.com/github/ribbons/forkme_right_gray_6d6d6d.png" alt="Fork me on GitHub" />
    </a>

    <div>
        <h2>Time played on each character</h2>
        <table>
            <tr>
                <td colspan="2" id="graph_character_played_title"></td>
            </tr>
            <tr>
                <td>
                    <canvas id="graph_character_played" width="1000" height="600" style="cursor: default;"></canvas>
                </td>
                <td>
                    <table id="legend"></table>
                </td>
            </tr>
        </table>
    </div>

    <div>
        <h2>Money on each character</h2>
        <table>
            <tr>
                <td colspan="2" id="graph_character_money_title"></td>
            </tr>
            <tr>
                <td>
                    <canvas id="graph_character_money" width="1000" height="600" style="cursor: default;"></canvas>
                </td>
                <td>
                    <table id="legend_money"></table>
                </td>
            </tr>
        </table>
    </div>

    <div>
        <h2>Time played per day</h2>
        <canvas id="graph_day_played" width="1000" height="600" style="cursor: default;"></canvas>
    </div>

    <div>
        <h2>Per-character percentage of time played</h2>
        <table>
            <tr>
                <td class="title">All time</td>
                <td class="title">Last 2 months</td>
                <td class="title">Last month</td>
            </tr>
            <tr>
                <td>
                    <canvas id="graph_characters_pie_all" width="400" height="400" style="cursor: default;"></canvas>
                </td>
                <td>
                    <canvas id="graph_characters_pie_2_months" width="400" height="400" style="cursor: default;"></canvas>
                </td>
                <td>
                    <canvas id="graph_characters_pie_1_month" width="400" height="400" style="cursor: default;"></canvas>
                </td>
            </tr>
            <tr>
                <td class="title">Last 2 weeks</td>
                <td class="title">Last week</td>
                <td class="title">Last 3 days</td>
            </tr>
            <tr>
                <td>
                    <canvas id="graph_characters_pie_2_weeks" width="400" height="400" style="cursor: default;"></canvas>
                </td>
                <td>
                    <canvas id="graph_characters_pie_1_week" width="400" height="400" style="cursor: default;"></canvas>
                </td>
                <td>
                    <canvas id="graph_characters_pie_3_days" width="400" height="400" style="cursor: default;"></canvas>
                </td>
            </tr>
        </table>
    </div>

    <span class="rgraph">Graphs generated with the  <a href="http://www.rgraph.net">RGraph library</a></span>

    <script type="text/javascript">
        window.onload = function ()
        {
            drawPerCharacterPlayTimeAndMoney();
            drawTotalPlayTime();
            drawCharactersPie('graph_characters_pie_all', null);
            drawCharactersPie('graph_characters_pie_2_months', 60);
            drawCharactersPie('graph_characters_pie_1_month', 30);
            drawCharactersPie('graph_characters_pie_2_weeks', 14);
            drawCharactersPie('graph_characters_pie_1_week', 7);
            drawCharactersPie('graph_characters_pie_3_days', 3);
        }
    </script>
</html>
